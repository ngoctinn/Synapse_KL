{
  "success": true,
  "description": "Synapse_KL Advanced Domain & Business Logic",
  "guidance": "# üß† SYNAPSE_KL DEEP DOMAIN CONTEXT\n\n## 1. ‚ö†Ô∏è PH√ÇN BI·ªÜT 2 LU·ªíNG QUAN TR·ªåNG\n\n### 1.1. Staff Schedule Management (Manual Assignment)\n- **M·ª•c ƒë√≠ch**: Admin qu·∫£n l√Ω ca l√†m vi·ªác c·ªßa nh√¢n vi√™n.\n- **C√¥ng ngh·ªá**: CRUD API th√¥ng th∆∞·ªùng (FastAPI + SQLModel).\n- **KH√îNG S·ª¨ D·ª§NG OR-Tools**.\n- **Use case**:\n  - T·∫°o/S·ª≠a/X√≥a ca l√†m vi·ªác (Shifts).\n  - Ph√¢n c√¥ng nh√¢n vi√™n v√†o ca (Staff Schedule).\n  - Publish l·ªãch l√†m vi·ªác tu·∫ßn/th√°ng.\n- **Module Frontend**: `/features/schedule` (ƒë√£ ho√†n thi·ªán).\n\n### 1.2. Booking Optimization (Automatic Assignment)\n- **M·ª•c ƒë√≠ch**: Kh√°ch h√†ng ƒë·∫∑t l·ªãch ‚Üí H·ªá th·ªëng t·ª± ƒë·ªông ph√¢n b·ªï Staff + Resource.\n- **C√¥ng ngh·ªá**: Google OR-Tools CP-SAT Solver.\n- **CH·ªà S·ª¨ D·ª§NG cho Booking Flow**.\n- **Input**:\n  - Service (duration, required_skills).\n  - Customer preferences (preferred_staff, time_window).\n  - Constraints (staff shifts, resource availability).\n- **Output**: Optimal assignment (staff_id, resource_id, time_slot).\n- **Endpoint**: `POST /bookings/optimize` ho·∫∑c `/scheduling/suggest-slots`.\n- **Module Frontend**: `/features/bookings` (ch∆∞a tri·ªÉn khai).\n\n**üö® CRITICAL**: OR-Tools CH·ªà d√πng cho Booking, KH√îNG d√πng cho Staff Schedule.\n\n---\n\n## 2. L√ïI NGHI·ªÜP V·ª§: BOOKING OPTIMIZATION (RCPSP)\nB√†i to√°n ƒë∆∞·ª£c m√¥ h√¨nh h√≥a l√† **X·∫øp l·ªãch d·ª± √°n c√≥ r√†ng bu·ªôc t√†i nguy√™n** v·ªõi h√†m m·ª•c ti√™u ƒëa bi·∫øn:\n\n### 2.1. H√†m M·ª•c Ti√™u (Objective Function)\n`Minimize Z = Œ±¬∑C_fair + Œ≤¬∑C_pref + Œ≥¬∑C_idle + Œ¥¬∑C_perturb`\n- **C_fair (C√¥ng b·∫±ng)**: T·ªëi thi·ªÉu h√≥a ƒë·ªô l·ªách t·∫£i tr·ªçng (workload) gi·ªØa c√°c nh√¢n vi√™n (Max Load - Min Load).\n- **C_pref (S·ªü th√≠ch)**: T·ªëi thi·ªÉu h√≥a vi·ªác kh√¥ng ƒë√°p ·ª©ng ƒë√∫ng nh√¢n vi√™n kh√°ch y√™u c·∫ßu.\n- **C_idle (Hi·ªáu su·∫•t)**: T·ªëi thi·ªÉu h√≥a kho·∫£ng tr·ªëng (gap) nh·ªè kh√¥ng s·ª≠ d·ª•ng ƒë∆∞·ª£c gi·ªØa c√°c ca.\n- **C_perturb (·ªîn ƒë·ªãnh)**: T·ªëi thi·ªÉu h√≥a s·ª± x√°o tr·ªôn khi ph·∫£i t√°i l·∫≠p l·ªãch (Rescheduling).\n- **Tr·ªçng s·ªë (Weights)**: Œ±, Œ≤, Œ≥, Œ¥ ƒë∆∞·ª£c chu·∫©n h√≥a v·ªÅ s·ªë nguy√™n [0-10] cho b·ªô gi·∫£i CP-SAT.\n\n### 2.2. R√†ng bu·ªôc (Constraints)\n- **R√†ng bu·ªôc c·ª©ng (Hard)**:\n  - `Resource Uniqueness`: 1 Nh√¢n vi√™n/Ph√≤ng ch·ªâ ph·ª•c v·ª• 1 kh√°ch t·∫°i 1 th·ªùi ƒëi·ªÉm.\n  - `Skill Matching`: K·ªπ nƒÉng nh√¢n vi√™n (Ks) ph·∫£i bao h√†m k·ªπ nƒÉng y√™u c·∫ßu c·ªßa d·ªãch v·ª• (Kreq ‚äÜ Ks).\n  - `Time Windows`: L·ªãch h·∫πn ph·∫£i n·∫±m trong ca l√†m vi·ªác (Shifts) c·ªßa nh√¢n vi√™n.\n- **R√†ng bu·ªôc m·ªÅm (Soft)**: C√¢n b·∫±ng t·∫£i, ∆∞u ti√™n kh√°ch h√†ng.\n\n## 3. PH√ÇN QUY·ªÄN & QUY TR√åNH (ACTORS & FLOWS)\n\n### 3.1. Actors\n- **Kh√°ch h√†ng (Customer)**: T√¨m khung gi·ªù tr·ªëng -> ƒê·∫∑t l·ªãch (Booking) -> Review.\n- **L·ªÖ t√¢n (Receptionist)**: Check-in/Check-out -> Thanh to√°n (Invoices) -> ƒêi·ªÅu ph·ªëi th·ªß c√¥ng n·∫øu c·∫ßn.\n- **K·ªπ thu·∫≠t vi√™n (Technician)**: Xem l·ªãch c√° nh√¢n -> C·∫≠p nh·∫≠t tr·∫°ng th√°i (Start/Finish) -> Ghi ch√∫ li·ªáu tr√¨nh.\n- **Qu·∫£n tr·ªã vi√™n (Admin)**: C·∫•u h√¨nh T√†i nguy√™n (Resources), D·ªãch v·ª• (Services), K·ªπ nƒÉng (Skills).\n\n### 3.2. Data Entities (Core)\n- `Service`: C√≥ `duration` v√† quan h·ªá N-N v·ªõi `Skills` (y√™u c·∫ßu k·ªπ nƒÉng).\n- `Resource`: Ph√≤ng/Gi∆∞·ªùng, ƒë·ªãnh danh duy nh·∫•t.\n- `Shift`: Ca l√†m vi·ªác c·ªßa nh√¢n vi√™n (Time slots).\n- `Booking`: Ch·ª©a nhi·ªÅu `BookingItem` (1 kh√°ch c√≥ th·ªÉ l√†m nhi·ªÅu d·ªãch v·ª•).\n\n## 4. C√îNG NGH·ªÜ & KI·∫æN TR√öC\n- **Backend**: Python FastAPI + SQLModel (ORM) + Alembic.\n- **Engine**: Google OR-Tools (CP-SAT Solver) ch·∫°y tr√™n Background Worker (CH·ªà cho Booking).\n- **Database**: PostgreSQL (Supabase) + Redis (Queue/Cache).\n- **Frontend**: Next.js 16 + Shadcn/UI (Tailwind CSS).",
  "critical_requirement": "M·ªçi logic Booking optimization ph·∫£i tu√¢n th·ªß h√†m m·ª•c ti√™u Z. Staff Schedule l√† Manual CRUD, kh√¥ng d√πng OR-Tools. Kh√¥ng hardcode logic x·∫øp l·ªãch ·ªü Frontend, ch·ªâ hi·ªÉn th·ªã k·∫øt qu·∫£ t·ª´ API.",
  "ai_response_instruction": "Ph·∫£n h·ªìi: 'Domain Rules Updated (Staff Schedule vs Booking Optimization).' v√† ch·ªù l·ªánh."
}
