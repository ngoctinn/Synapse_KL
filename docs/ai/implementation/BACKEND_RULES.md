# Backend Rules (FastAPI + SQLModel)

> Tài liệu này là **LUẬT BẮT BUỘC** khi sinh code backend. Không có ngoại lệ.

---

## 1. TECH STACK

- Python ≥3.10 (ưu tiên 3.12+)
- FastAPI + SQLModel + Pydantic v2
- Alembic cho migrations
- PostgreSQL + asyncpg
- Poetry hoặc uv cho dependency

---

## 2. KIẾN TRÚC 3 LỚP (BẮT BUỘC)

| Lớp | Vị trí | Trách nhiệm |
|-----|--------|-------------|
| **Router** | `modules/<module>/router.py` | HTTP endpoints, validation, status codes |
| **Service** | `modules/<module>/service.py` | Business logic, orchestration |
| **Model** | `modules/<module>/models.py` | SQLModel entities, relationships |

### Quy tắc import:
- Router → Service → Model ✅
- Model → Service ❌
- Service → Router ❌
- Router → Model (chỉ cho type hints) ✅

---

## 3. SQLMODEL RULES

- PHẢI dùng `table=True` cho database models
- PHẢI dùng `Relationship` với `back_populates` cho quan hệ 2 chiều
- PHẢI dùng UUID làm primary key
- PHẢI có `created_at`, `updated_at` cho mọi entity
- PHẢI dùng `expire_on_commit=False` trong async session
- PHẢI dùng `selectinload` hoặc `joinedload` để tránh N+1

---

## 4. PYDANTIC V2 RULES

| Cũ (v1) | Mới (v2) - BẮT BUỘC |
|---------|---------------------|
| `orm_mode=True` | `ConfigDict(from_attributes=True)` |
| `@validator` | `@field_validator` |
| `.dict()` | `.model_dump()` |
| `.json()` | `.model_dump_json()` |

### Schema Naming:
- `{Entity}Create` - tạo mới
- `{Entity}Update` - cập nhật (Optional fields)
- `{Entity}Read` - response
- `{Entity}List` - list response

---

## 5. ERROR HANDLING

- PHẢI dùng custom exceptions kế thừa `HTTPException`
- PHẢI có global exception handler
- PHẢI log tất cả unhandled exceptions
- PHẢI trả về structured error response: `{"detail": "..."}`

### Status codes:
| Operation | Success | Errors |
|-----------|---------|--------|
| GET | 200 | 404 |
| POST | 201 | 400, 409, 422 |
| PUT/PATCH | 200 | 400, 404, 422 |
| DELETE | 204 | 404 |

---

## 6. ALEMBIC MIGRATIONS

- PHẢI một thay đổi = một migration
- PHẢI implement `downgrade()` cho mọi migration
- PHẢI test migration trên staging trước production
- PHẢI backup database trước khi migrate
- PHẢI review autogenerated migration trước khi apply
- CẤM import model trực tiếp trong migration script

---

## 7. TESTING RULES

- PHẢI dùng `pytest-asyncio` hoặc `pytest-anyio`
- PHẢI dùng separate test database
- PHẢI dùng `dependency_overrides` để mock
- PHẢI disable connection pooling trong tests (`poolclass=NullPool`)
- PHẢI có unit tests cho services
- PHẢI có integration tests cho routers

---

## 8. SECURITY RULES

### Authentication:
- PHẢI dùng JWT với short-lived access tokens (15-30 phút)
- PHẢI implement refresh token
- PHẢI store tokens trong HTTP-only, Secure cookies
- PHẢI có token revocation/blacklist

### Authorization:
- PHẢI implement RBAC (Role-Based Access Control)
- PHẢI dùng FastAPI `Depends()` cho role checking
- PHẢI tách authorization logic khỏi business logic

### General:
- PHẢI enforce HTTPS trong production
- PHẢI validate và sanitize mọi user input
- PHẢI implement rate limiting
- PHẢI configure CORS policies
- PHẢI rotate secrets định kỳ
- CẤM hardcode secrets trong code

---

## 9. API DESIGN RULES

- PHẢI dùng plural nouns: `/services`, `/appointments`
- PHẢI dùng kebab-case: `/service-categories`
- PHẢI dùng path params cho specific resource: `/{id}`
- PHẢI dùng query params cho filtering
- PHẢI implement pagination cho list endpoints
- PHẢI có health check endpoint `/health`

---

## 10. CODE STYLE RULES

- PHẢI dùng type hints cho tất cả functions
- PHẢI dùng `async/await` cho database operations
- PHẢI dùng dependency injection qua `Depends()`
- CẤM business logic trong router
- CẤM database queries trong router
- CẤM circular imports
- CẤM wildcard imports (`from x import *`)

---

## 11. PRODUCTION RULES

- PHẢI set `DEBUG=False`
- PHẢI dùng Gunicorn + Uvicorn workers
- PHẢI enable database connection pooling
- PHẢI implement caching với Redis
- PHẢI có comprehensive logging
- PHẢI run migrations trước deployment

---

*Cập nhật: December 2025*
